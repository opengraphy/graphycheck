//open options page on install
chrome.runtime.onInstalled.addListener((details) => {
  if (details.reason === chrome.runtime.OnInstalledReason.INSTALL) {
    chrome.runtime.openOptionsPage();
  }
});

//create context menu
chrome.runtime.onInstalled.addListener(() => {
  chrome.contextMenus.create({
    id: "convertToChatGPT",
    title: "Corriger le texte",
    contexts: ["selection"],
  });
});

//open modal on context menu click
chrome.contextMenus.onClicked.addListener((info, tab) => {
  if (info.menuItemId === "convertToChatGPT") {
    chrome.scripting.executeScript({
      target: { tabId: tab.id },
      function: showCustomModalWithSelection,
      args: [info.menuItemId],
    });
  }
});

//open options page function for button from modal
chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
  if (request.action === "openOptions") {
    chrome.runtime.openOptionsPage();
  }
});

function showCustomModalWithSelection() {
  const modalHTML = `
  <div class="orthoGraphyModal">
    <div id="customModal" class="modal">
      <article class="modal-container">
        <header class="modal-container-header">
          <h1 class="modal-container-title">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32pt" height="32pt" viewBox="0 0 32 32" version="1.1">
              <g id="surface1">
                <path style=" stroke:none;fill-rule:nonzero;fill:rgb(0.392157%,67.843137%,29.803922%);fill-opacity:1;" d="M 22.257812 9.449219 C 22.410156 9.515625 22.496094 9.597656 22.613281 9.714844 C 22.679688 9.78125 22.679688 9.78125 22.75 9.851562 C 22.800781 9.902344 22.851562 9.953125 22.902344 10.007812 C 22.957031 10.058594 23.007812 10.113281 23.0625 10.167969 C 23.207031 10.3125 23.355469 10.457031 23.5 10.605469 C 23.648438 10.757812 23.800781 10.910156 23.953125 11.0625 C 24.242188 11.347656 24.527344 11.636719 24.816406 11.925781 C 25.140625 12.253906 25.46875 12.582031 25.796875 12.910156 C 26.46875 13.585938 27.140625 14.261719 27.8125 14.9375 C 27.726562 15.136719 27.621094 15.269531 27.46875 15.421875 C 27.398438 15.492188 27.398438 15.492188 27.328125 15.5625 C 27.277344 15.613281 27.226562 15.664062 27.175781 15.714844 C 27.09375 15.796875 27.09375 15.796875 27.011719 15.878906 C 26.863281 16.027344 26.714844 16.179688 26.566406 16.328125 C 26.40625 16.488281 26.246094 16.648438 26.085938 16.808594 C 25.734375 17.164062 25.382812 17.515625 25.03125 17.863281 C 24.8125 18.085938 24.59375 18.304688 24.375 18.523438 C 23.769531 19.132812 23.164062 19.738281 22.554688 20.34375 C 22.515625 20.382812 22.480469 20.421875 22.4375 20.460938 C 22.359375 20.542969 22.28125 20.621094 22.203125 20.699219 C 22.164062 20.738281 22.125 20.777344 22.085938 20.816406 C 22.027344 20.875 22.027344 20.875 21.964844 20.9375 C 21.332031 21.570312 20.699219 22.207031 20.0625 22.84375 C 19.414062 23.496094 18.761719 24.144531 18.113281 24.796875 C 17.746094 25.164062 17.378906 25.53125 17.015625 25.894531 C 16.707031 26.207031 16.394531 26.519531 16.082031 26.832031 C 15.921875 26.988281 15.765625 27.148438 15.605469 27.308594 C 15.433594 27.480469 15.261719 27.652344 15.089844 27.824219 C 15.039062 27.875 14.988281 27.925781 14.9375 27.976562 C 14.890625 28.023438 14.84375 28.070312 14.796875 28.117188 C 14.757812 28.15625 14.71875 28.195312 14.675781 28.238281 C 14.5625 28.3125 14.5625 28.3125 14.429688 28.300781 C 14.277344 28.234375 14.191406 28.152344 14.074219 28.035156 C 14.03125 27.988281 13.984375 27.945312 13.9375 27.898438 C 13.886719 27.847656 13.835938 27.796875 13.785156 27.742188 C 13.707031 27.664062 13.707031 27.664062 13.625 27.582031 C 13.480469 27.4375 13.332031 27.292969 13.1875 27.144531 C 13.039062 26.992188 12.886719 26.839844 12.734375 26.6875 C 12.445312 26.402344 12.160156 26.113281 11.871094 25.824219 C 11.546875 25.496094 11.21875 25.167969 10.890625 24.839844 C 10.21875 24.164062 9.546875 23.488281 8.875 22.8125 C 8.960938 22.613281 9.066406 22.480469 9.21875 22.328125 C 9.289062 22.257812 9.289062 22.257812 9.359375 22.1875 C 9.410156 22.136719 9.460938 22.085938 9.511719 22.035156 C 9.59375 21.953125 9.59375 21.953125 9.675781 21.871094 C 9.824219 21.722656 9.972656 21.570312 10.121094 21.421875 C 10.28125 21.261719 10.441406 21.101562 10.601562 20.941406 C 10.953125 20.585938 11.304688 20.234375 11.65625 19.886719 C 11.875 19.664062 12.09375 19.445312 12.3125 19.226562 C 12.917969 18.617188 13.523438 18.011719 14.132812 17.40625 C 14.1875 17.347656 14.1875 17.347656 14.25 17.289062 C 14.328125 17.207031 14.40625 17.128906 14.484375 17.050781 C 14.542969 16.992188 14.542969 16.992188 14.601562 16.933594 C 14.640625 16.894531 14.679688 16.855469 14.722656 16.8125 C 15.355469 16.179688 15.988281 15.542969 16.625 14.90625 C 17.273438 14.253906 17.925781 13.605469 18.574219 12.953125 C 18.941406 12.585938 19.308594 12.21875 19.671875 11.855469 C 19.980469 11.542969 20.292969 11.230469 20.605469 10.917969 C 20.765625 10.761719 20.921875 10.601562 21.082031 10.441406 C 21.253906 10.269531 21.425781 10.097656 21.597656 9.925781 C 21.648438 9.875 21.699219 9.824219 21.75 9.773438 C 21.796875 9.726562 21.84375 9.679688 21.890625 9.632812 C 21.949219 9.574219 21.949219 9.574219 22.011719 9.511719 C 22.125 9.4375 22.125 9.4375 22.257812 9.449219 Z M 22.257812 9.449219 "/>
                <path style=" stroke:none;fill-rule:nonzero;fill:rgb(0.392157%,68.235294%,29.411765%);fill-opacity:1;" d="M 13.1875 2.9375 C 13.339844 3.074219 13.410156 3.183594 13.480469 3.375 C 13.507812 3.449219 13.507812 3.449219 13.535156 3.527344 C 13.554688 3.582031 13.574219 3.636719 13.59375 3.691406 C 13.613281 3.75 13.632812 3.804688 13.652344 3.863281 C 13.699219 3.984375 13.742188 4.105469 13.785156 4.230469 C 13.851562 4.417969 13.917969 4.605469 13.988281 4.796875 C 14.078125 5.042969 14.164062 5.289062 14.253906 5.539062 C 14.402344 5.953125 14.554688 6.371094 14.707031 6.785156 C 14.726562 6.84375 14.75 6.902344 14.773438 6.964844 C 14.792969 7.019531 14.8125 7.070312 14.832031 7.125 C 14.847656 7.167969 14.863281 7.214844 14.878906 7.257812 C 14.996094 7.488281 15.144531 7.585938 15.378906 7.671875 C 15.429688 7.691406 15.480469 7.710938 15.535156 7.730469 C 15.589844 7.75 15.644531 7.773438 15.703125 7.792969 C 15.761719 7.816406 15.820312 7.835938 15.878906 7.859375 C 16.355469 8.035156 16.832031 8.199219 17.308594 8.363281 C 18.066406 8.625 18.8125 8.90625 19.5625 9.1875 C 19.5625 9.230469 19.5625 9.269531 19.5625 9.3125 C 19.527344 9.324219 19.492188 9.335938 19.457031 9.351562 C 19.09375 9.480469 18.730469 9.613281 18.371094 9.742188 C 18.234375 9.789062 18.101562 9.839844 17.964844 9.886719 C 16.785156 10.3125 16.785156 10.3125 15.621094 10.765625 C 15.5 10.8125 15.5 10.8125 15.367188 10.847656 C 15.097656 10.925781 15.019531 10.964844 14.875 11.214844 C 14.839844 11.304688 14.8125 11.394531 14.78125 11.484375 C 14.765625 11.535156 14.746094 11.585938 14.730469 11.636719 C 14.691406 11.742188 14.65625 11.851562 14.621094 11.957031 C 14.542969 12.1875 14.457031 12.410156 14.375 12.636719 C 14.265625 12.9375 14.15625 13.234375 14.050781 13.53125 C 13.984375 13.714844 13.917969 13.894531 13.851562 14.078125 C 13.8125 14.191406 13.773438 14.300781 13.730469 14.414062 C 13.675781 14.566406 13.621094 14.722656 13.5625 14.875 C 13.539062 14.933594 13.519531 14.992188 13.496094 15.050781 C 13.476562 15.105469 13.453125 15.164062 13.429688 15.222656 C 13.402344 15.300781 13.402344 15.300781 13.371094 15.378906 C 13.3125 15.5 13.3125 15.5 13.1875 15.5625 C 13.175781 15.527344 13.160156 15.492188 13.148438 15.457031 C 13.011719 15.082031 12.875 14.710938 12.738281 14.335938 C 12.6875 14.199219 12.636719 14.058594 12.585938 13.921875 C 12.5625 13.855469 12.535156 13.789062 12.511719 13.71875 C 12.488281 13.652344 12.464844 13.585938 12.4375 13.519531 C 12.386719 13.382812 12.339844 13.25 12.289062 13.113281 C 12.160156 12.769531 12.039062 12.425781 11.925781 12.074219 C 11.707031 11.292969 11.707031 11.292969 11.160156 10.746094 C 10.96875 10.6875 10.96875 10.6875 10.769531 10.648438 C 10.621094 10.605469 10.472656 10.5625 10.324219 10.519531 C 10.285156 10.507812 10.246094 10.496094 10.203125 10.488281 C 9.695312 10.347656 9.203125 10.15625 8.710938 9.96875 C 8.457031 9.875 8.203125 9.78125 7.945312 9.6875 C 7.609375 9.5625 7.273438 9.4375 6.9375 9.3125 C 6.9375 9.269531 6.9375 9.230469 6.9375 9.1875 C 7.007812 9.160156 7.007812 9.160156 7.082031 9.132812 C 7.535156 8.96875 7.992188 8.804688 8.445312 8.636719 C 8.679688 8.554688 8.914062 8.46875 9.144531 8.382812 C 9.371094 8.300781 9.597656 8.21875 9.824219 8.136719 C 9.910156 8.105469 9.992188 8.074219 10.078125 8.042969 C 10.121094 8.027344 10.160156 8.011719 10.203125 7.996094 C 10.242188 7.984375 10.285156 7.96875 10.324219 7.953125 C 10.4375 7.910156 10.554688 7.867188 10.667969 7.824219 C 10.875 7.75 10.875 7.75 11.058594 7.699219 C 11.300781 7.625 11.453125 7.570312 11.597656 7.355469 C 11.683594 7.167969 11.753906 6.976562 11.820312 6.777344 C 11.859375 6.671875 11.859375 6.671875 11.898438 6.5625 C 11.980469 6.332031 12.058594 6.101562 12.136719 5.871094 C 12.191406 5.71875 12.242188 5.566406 12.296875 5.417969 C 12.402344 5.125 12.503906 4.828125 12.605469 4.535156 C 12.792969 4 12.988281 3.46875 13.1875 2.9375 Z M 13.1875 2.9375 "/>
                <path style=" stroke:none;fill-rule:nonzero;fill:rgb(0.392157%,68.235294%,29.803922%);fill-opacity:1;" d="M 26.765625 5.214844 C 26.820312 5.210938 26.878906 5.207031 26.933594 5.203125 C 27.140625 5.253906 27.203125 5.304688 27.359375 5.445312 C 27.402344 5.484375 27.445312 5.523438 27.492188 5.566406 C 27.691406 5.75 27.886719 5.9375 28.082031 6.125 C 28.148438 6.1875 28.148438 6.1875 28.214844 6.253906 C 28.601562 6.632812 28.992188 7.011719 29.378906 7.394531 C 29.636719 7.652344 29.898438 7.90625 30.160156 8.160156 C 30.414062 8.40625 30.664062 8.65625 30.917969 8.90625 C 31.011719 9 31.109375 9.09375 31.203125 9.1875 C 32.054688 10.003906 32.054688 10.003906 32.09375 10.460938 C 32.03125 10.898438 31.746094 11.148438 31.4375 11.4375 C 31.34375 11.535156 31.246094 11.632812 31.152344 11.734375 C 30.894531 12 30.628906 12.265625 30.367188 12.53125 C 30.253906 12.644531 30.140625 12.757812 30.03125 12.871094 C 29.867188 13.039062 29.703125 13.203125 29.539062 13.371094 C 29.488281 13.421875 29.4375 13.472656 29.386719 13.527344 C 29.316406 13.597656 29.316406 13.597656 29.242188 13.667969 C 29.203125 13.710938 29.160156 13.75 29.117188 13.792969 C 29 13.875 29 13.875 28.882812 13.863281 C 28.71875 13.800781 28.636719 13.722656 28.511719 13.597656 C 28.46875 13.550781 28.421875 13.507812 28.375 13.460938 C 28.324219 13.410156 28.273438 13.359375 28.222656 13.304688 C 28.144531 13.226562 28.144531 13.226562 28.0625 13.144531 C 27.917969 13 27.769531 12.855469 27.625 12.707031 C 27.476562 12.554688 27.324219 12.402344 27.171875 12.25 C 26.882812 11.964844 26.597656 11.675781 26.308594 11.386719 C 25.984375 11.058594 25.65625 10.730469 25.328125 10.402344 C 24.65625 9.726562 23.984375 9.050781 23.3125 8.375 C 23.414062 8.160156 23.53125 8.015625 23.699219 7.847656 C 23.753906 7.792969 23.808594 7.738281 23.863281 7.679688 C 23.925781 7.621094 23.984375 7.5625 24.042969 7.503906 C 24.101562 7.441406 24.164062 7.382812 24.226562 7.320312 C 24.351562 7.191406 24.480469 7.066406 24.609375 6.9375 C 24.773438 6.773438 24.933594 6.613281 25.097656 6.449219 C 25.222656 6.320312 25.347656 6.195312 25.476562 6.070312 C 25.535156 6.011719 25.59375 5.949219 25.65625 5.890625 C 25.738281 5.804688 25.824219 5.722656 25.910156 5.636719 C 25.980469 5.566406 25.980469 5.566406 26.054688 5.492188 C 26.28125 5.292969 26.464844 5.226562 26.765625 5.214844 Z M 26.765625 5.214844 "/>
                <path style=" stroke:none;fill-rule:nonzero;fill:rgb(0.392157%,67.843137%,29.803922%);fill-opacity:1;" d="M 7.75 23.8125 C 7.949219 23.898438 8.082031 24.003906 8.234375 24.15625 C 8.28125 24.199219 8.324219 24.246094 8.371094 24.292969 C 8.421875 24.339844 8.472656 24.390625 8.523438 24.441406 C 8.574219 24.492188 8.628906 24.546875 8.683594 24.597656 C 8.824219 24.742188 8.96875 24.882812 9.113281 25.027344 C 9.203125 25.117188 9.292969 25.207031 9.382812 25.296875 C 9.695312 25.605469 10.007812 25.917969 10.320312 26.230469 C 10.609375 26.519531 10.902344 26.8125 11.195312 27.101562 C 11.445312 27.347656 11.695312 27.597656 11.945312 27.847656 C 12.09375 27.996094 12.242188 28.144531 12.394531 28.292969 C 12.5625 28.460938 12.726562 28.625 12.894531 28.792969 C 12.941406 28.84375 12.992188 28.890625 13.042969 28.941406 C 13.113281 29.007812 13.113281 29.007812 13.179688 29.078125 C 13.21875 29.117188 13.257812 29.15625 13.300781 29.199219 C 13.375 29.3125 13.375 29.3125 13.359375 29.445312 C 13.222656 29.78125 12.9375 30.003906 12.613281 30.15625 C 11.875 30.425781 11.125 30.644531 10.367188 30.855469 C 10.09375 30.933594 9.824219 31.007812 9.550781 31.085938 C 9.484375 31.105469 9.417969 31.125 9.347656 31.144531 C 8.910156 31.265625 8.480469 31.390625 8.046875 31.523438 C 7.9375 31.554688 7.828125 31.585938 7.722656 31.617188 C 7.570312 31.664062 7.417969 31.710938 7.265625 31.757812 C 6.039062 32.132812 6.039062 32.132812 5.550781 31.945312 C 5.402344 31.851562 5.339844 31.777344 5.25 31.625 C 5.171875 31.039062 5.285156 30.5 5.457031 29.941406 C 5.480469 29.867188 5.5 29.792969 5.523438 29.714844 C 5.582031 29.519531 5.640625 29.320312 5.703125 29.121094 C 5.761719 28.917969 5.824219 28.710938 5.886719 28.503906 C 5.957031 28.257812 6.03125 28.007812 6.105469 27.761719 C 6.25 27.28125 6.390625 26.796875 6.523438 26.308594 C 6.554688 26.199219 6.585938 26.089844 6.613281 25.980469 C 6.65625 25.832031 6.699219 25.679688 6.738281 25.53125 C 6.875 25.023438 7.003906 24.574219 7.375 24.1875 C 7.410156 24.152344 7.445312 24.113281 7.480469 24.074219 C 7.570312 23.984375 7.660156 23.898438 7.75 23.8125 Z M 7.75 23.8125 "/>
                <path style=" stroke:none;fill-rule:nonzero;fill:rgb(0.392157%,68.235294%,29.411765%);fill-opacity:1;" d="M 4.125 9.125 C 4.167969 9.125 4.207031 9.125 4.25 9.125 C 4.269531 9.1875 4.289062 9.25 4.308594 9.3125 C 4.390625 9.5625 4.476562 9.8125 4.5625 10.0625 C 4.632812 10.269531 4.695312 10.480469 4.761719 10.6875 C 4.8125 10.839844 4.863281 10.992188 4.914062 11.144531 C 4.9375 11.21875 4.957031 11.292969 4.980469 11.367188 C 5.113281 11.757812 5.113281 11.757812 5.402344 12.042969 C 5.597656 12.125 5.796875 12.1875 6 12.25 C 6.125 12.296875 6.25 12.34375 6.375 12.390625 C 6.507812 12.441406 6.636719 12.492188 6.769531 12.539062 C 6.816406 12.558594 6.859375 12.574219 6.902344 12.589844 C 6.949219 12.605469 6.992188 12.625 7.039062 12.640625 C 7.175781 12.691406 7.3125 12.742188 7.449219 12.792969 C 7.53125 12.824219 7.617188 12.855469 7.699219 12.886719 C 7.84375 12.941406 7.988281 12.992188 8.125 13.0625 C 8.125 13.105469 8.125 13.144531 8.125 13.1875 C 8.070312 13.207031 8.015625 13.226562 7.960938 13.246094 C 7.753906 13.320312 7.546875 13.390625 7.34375 13.464844 C 7.253906 13.496094 7.164062 13.527344 7.078125 13.558594 C 6.558594 13.742188 6.039062 13.929688 5.527344 14.132812 C 5.375 14.1875 5.375 14.1875 5.25 14.1875 C 5.242188 14.222656 5.230469 14.253906 5.222656 14.289062 C 5.070312 14.816406 4.875 15.324219 4.679688 15.835938 C 4.628906 15.972656 4.578125 16.109375 4.523438 16.242188 C 4.492188 16.328125 4.460938 16.410156 4.429688 16.496094 C 4.359375 16.683594 4.292969 16.867188 4.25 17.0625 C 4.1875 17.0625 4.125 17.0625 4.0625 17.0625 C 4.050781 17.027344 4.039062 16.988281 4.023438 16.953125 C 3.769531 16.203125 3.503906 15.457031 3.214844 14.71875 C 3.195312 14.664062 3.175781 14.613281 3.15625 14.5625 C 3.136719 14.515625 3.117188 14.472656 3.101562 14.425781 C 3.0625 14.3125 3.0625 14.3125 3.0625 14.1875 C 2.945312 14.152344 2.945312 14.152344 2.824219 14.121094 C 2.300781 13.960938 1.789062 13.769531 1.273438 13.582031 C 1.167969 13.542969 1.0625 13.503906 0.957031 13.46875 C 0.699219 13.375 0.445312 13.28125 0.1875 13.1875 C 0.207031 13.125 0.230469 13.0625 0.25 13 C 0.421875 12.921875 0.421875 12.921875 0.652344 12.84375 C 0.691406 12.828125 0.734375 12.8125 0.777344 12.800781 C 0.90625 12.753906 1.039062 12.707031 1.171875 12.664062 C 1.257812 12.632812 1.34375 12.605469 1.429688 12.574219 C 1.472656 12.5625 1.515625 12.546875 1.558594 12.53125 C 1.644531 12.5 1.730469 12.472656 1.8125 12.441406 C 2.015625 12.371094 2.214844 12.304688 2.421875 12.246094 C 2.816406 12.128906 2.816406 12.128906 3.105469 11.851562 C 3.191406 11.652344 3.253906 11.457031 3.3125 11.25 C 3.359375 11.121094 3.40625 10.992188 3.453125 10.863281 C 3.539062 10.636719 3.621094 10.40625 3.703125 10.175781 C 3.769531 9.988281 3.835938 9.804688 3.902344 9.617188 C 3.917969 9.574219 3.933594 9.535156 3.949219 9.488281 C 4.054688 9.195312 4.054688 9.195312 4.125 9.125 Z M 4.125 9.125 "/>
                <path style=" stroke:none;fill-rule:nonzero;fill:rgb(0.392157%,68.235294%,29.411765%);fill-opacity:1;" d="M 6.5625 0.25 C 6.625 0.269531 6.6875 0.292969 6.75 0.3125 C 6.828125 0.472656 6.828125 0.472656 6.902344 0.683594 C 6.929688 0.757812 6.957031 0.835938 6.984375 0.910156 C 7.015625 0.992188 7.042969 1.070312 7.070312 1.152344 C 7.097656 1.230469 7.128906 1.3125 7.15625 1.390625 C 7.210938 1.539062 7.261719 1.683594 7.3125 1.832031 C 7.371094 1.996094 7.371094 1.996094 7.4375 2.125 C 7.558594 2.179688 7.683594 2.226562 7.808594 2.273438 C 7.882812 2.300781 7.960938 2.328125 8.035156 2.355469 C 8.117188 2.382812 8.195312 2.414062 8.277344 2.441406 C 8.433594 2.496094 8.589844 2.554688 8.746094 2.613281 C 8.816406 2.636719 8.886719 2.660156 8.957031 2.6875 C 9.125 2.75 9.125 2.75 9.25 2.8125 C 9.25 2.855469 9.25 2.894531 9.25 2.9375 C 9.175781 2.964844 9.175781 2.964844 9.097656 2.992188 C 8.910156 3.0625 8.726562 3.128906 8.539062 3.199219 C 8.457031 3.226562 8.378906 3.257812 8.296875 3.285156 C 8.183594 3.328125 8.066406 3.371094 7.949219 3.414062 C 7.878906 3.4375 7.808594 3.464844 7.738281 3.492188 C 7.511719 3.582031 7.398438 3.632812 7.300781 3.863281 C 7.273438 3.933594 7.25 4.007812 7.226562 4.082031 C 7.199219 4.160156 7.171875 4.238281 7.144531 4.316406 C 7.105469 4.441406 7.0625 4.566406 7.019531 4.691406 C 6.980469 4.8125 6.941406 4.933594 6.898438 5.054688 C 6.875 5.125 6.851562 5.199219 6.824219 5.273438 C 6.800781 5.328125 6.777344 5.382812 6.75 5.4375 C 6.6875 5.457031 6.625 5.480469 6.5625 5.5 C 6.542969 5.429688 6.542969 5.429688 6.519531 5.359375 C 6.398438 4.953125 6.269531 4.546875 6.128906 4.148438 C 6.113281 4.105469 6.101562 4.0625 6.085938 4.019531 C 5.984375 3.734375 5.890625 3.636719 5.625 3.5 C 5.503906 3.449219 5.378906 3.402344 5.253906 3.359375 C 5.148438 3.320312 5.148438 3.320312 5.042969 3.285156 C 4.96875 3.257812 4.898438 3.234375 4.824219 3.207031 C 4.75 3.179688 4.679688 3.15625 4.601562 3.128906 C 4.421875 3.0625 4.242188 3 4.0625 2.9375 C 4.0625 2.894531 4.0625 2.855469 4.0625 2.8125 C 4.117188 2.796875 4.167969 2.777344 4.222656 2.761719 C 4.421875 2.695312 4.621094 2.628906 4.820312 2.558594 C 4.90625 2.53125 4.992188 2.503906 5.078125 2.476562 C 5.601562 2.316406 5.601562 2.316406 5.996094 1.953125 C 6.078125 1.761719 6.136719 1.574219 6.1875 1.375 C 6.222656 1.269531 6.261719 1.160156 6.300781 1.054688 C 6.332031 0.960938 6.363281 0.863281 6.394531 0.765625 C 6.410156 0.714844 6.425781 0.664062 6.445312 0.613281 C 6.484375 0.492188 6.523438 0.371094 6.5625 0.25 Z M 6.5625 0.25 "/>
              </g>
            </svg>
            Correction du texte
          </h1>
          <button id="closeButton" class="icon-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
              <path fill="none" d="M0 0h24v24H0z" />
              <path fill="currentColor" d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z" />
            </svg>
          </button>
        </header>
        <section class="modal-container-body rtf">
          <div class="loaderContainer">
            <span class="orthoBotLoader"></span>
            <p>Chargement</p>
          </div>
        </section>
        <footer class="modal-container-footer">
          <button id="cancelButton" class="button is-ghost">Annuler</button>
          <button id="confirmButton" class="button is-primary">Confirmer</button>
        </footer>
      </article>
    </div>
  </div>
  `;

  const { range, selectedHtml } = getSelectionHtml();

  if (!range) return;

  const modalWrapper = document.createElement("div");
  modalWrapper.innerHTML = modalHTML;
  document.body.appendChild(modalWrapper);

  document.getElementById("cancelButton").addEventListener("click", closeModal);
  document.getElementById("closeButton").addEventListener("click", closeModal);

  chrome.storage.local.get("apiKey", async function (result) {
    if (result?.apiKey) {
      let text = "";
      callChatGPT(selectedHtml, result.apiKey).then((response) => {
        if (response) {
          text = response;
          document.querySelector(".modal-container-body").innerHTML = text;

          document
            .getElementById("confirmButton")
            .addEventListener("click", () => {
              replaceSelectionWithText(range, text);
              closeModal();
            });
        }
      });
    } else {
      document.querySelector(".modal-container-body").innerHTML =
        '<div style="text-align:center;"><p class="error" style="margin:0;">Veuillez renseigner une clé API valide dans les options de l\'extension</p><button id="goToOption" class="button is-primary" style="margin-top:12px;">Go to options</button></div>';
      document.getElementById("goToOption").addEventListener("click", () => {
        chrome.runtime.sendMessage({ action: "openOptions" });
      });
    }
  });

  function getSelectionHtml() {
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    if (range.toString().trim() !== "") {
      const fragment = range.cloneContents();
      const div = document.createElement("div");
      div.appendChild(fragment);
      return {
        range: range,
        selectedHtml: div.innerHTML,
      };
    }
    closeModal();
    return {
      range: null,
      selectedHtml: "",
    };
  }

  function closeModal() {
    const modal = document.getElementById("customModal");
    if (modal) {
      modal.remove();
    }
  }

  function replaceSelectionWithText(range, newHtml) {
    if (newHtml.trim() === "") return;
    range.deleteContents();
    const div = document.createElement("div");
    div.innerHTML = newHtml;
    const fragment = document.createDocumentFragment();
    let node;
    while ((node = div.firstChild)) {
      fragment.appendChild(node);
    }
    range.insertNode(fragment);
  }

  async function callChatGPT(prompt, apiKey) {
    const url = "https://api.openai.com/v1/chat/completions";

    const body = {
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content:
            "Tu es un assistant qui corrige l'orthographe et la grammaire. Corrige les erreurs dans le texte fourni tout en conservant le formatage d'origine (espaces, sauts de ligne, etc.), et renvoie uniquement le texte corrigé en HTML, sans entourer la réponse de blocs de code comme ``` ou ```html.",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      max_tokens: 2048,
    };

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify(body),
    });

    if (!response.ok) {
      if (response.status === 401) {
        document.querySelector(".modal-container-body").innerHTML =
          '<div style="text-align:center;"><p class="error" style="margin:0;">Veuillez renseigner une clé API valide dans les options de l\'extension</p><button id="goToOption" class="button is-primary" style="margin-top:12px;">Go to options</button></div>';
        document.getElementById("goToOption").addEventListener("click", () => {
          chrome.runtime.sendMessage({ action: "openOptions" });
        });
        return;
      }
    }

    const data = await response.json();
    return data.choices[0].message.content;
  }
}
